<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Rust Lambda Hello World Logging | MillerJAM Site</title><meta name=keywords content><meta name=description content="Use the 'tracing' crate to add logging to our Serverless Lambdas written in Rust"><meta name=author content><link rel=canonical href=http://millerjam.github.io/posts/rust-lambda-hello-world-logging/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://millerjam.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://millerjam.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://millerjam.github.io/favicon-32x32.png><link rel=apple-touch-icon href=http://millerjam.github.io/apple-touch-icon.png><link rel=mask-icon href=http://millerjam.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Rust Lambda Hello World Logging"><meta property="og:description" content="Use the 'tracing' crate to add logging to our Serverless Lambdas written in Rust"><meta property="og:type" content="article"><meta property="og:url" content="http://millerjam.github.io/posts/rust-lambda-hello-world-logging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-13T14:35:38-04:00"><meta property="article:modified_time" content="2022-03-13T14:35:38-04:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rust Lambda Hello World Logging"><meta name=twitter:description content="Use the 'tracing' crate to add logging to our Serverless Lambdas written in Rust"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://millerjam.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Rust Lambda Hello World Logging","item":"http://millerjam.github.io/posts/rust-lambda-hello-world-logging/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Rust Lambda Hello World Logging","name":"Rust Lambda Hello World Logging","description":"Use the 'tracing' crate to add logging to our Serverless Lambdas written in Rust","keywords":[],"articleBody":"In my previous article, I started a tutorial on creating a lambda in Rust. If you missed it, you can catch up on that article here - Rust Lambda Hello World\nLets add some logging Before we go much further with our Rust code, let’s add some logging. We are take advantage of the tracing library which is already integrated into many of the lambda dependencies.\n Details about the tracing library are out of scope for this article, but you can learn more from the tracing crate docs\n Init the logger Setting up the logger requires initializing the tracing subscriber library, the AWS Lambda Rust Runtime Examples has a examples with some details about how to get started.\nHere is the code that we will have to add:\nfn init_lambda_tracing() {  tracing_subscriber::fmt()  .with_max_level(tracing::Level::INFO)  // this needs to be set to false, otherwise ANSI color codes will  // show up in a confusing manner in CloudWatch logs.  .with_ansi(false)  // disabling time is handy because CloudWatch will add the ingestion time.  .without_time()  .init(); } I have created a small function init_lambda_tracing() with all the details for setting up the logging. This function will setup the default tracing_subscriber which prints logs to stdout. The additional methods called on the builder, set the default logging level to “info” and disable some of the defaults to make things nicer in the Lambda environment. Finally, I added additional code to the main() to call this function before the lambda runtime setup.\nFix the compile issues Even though we did not add any additional import ... lines, we still need to add our new tracing library dependencies to Cargo.toml, before our code will build.\n The reason we did not add import.. statements is that we fully qualified the crate directly in the code with the prefix tracing_subscriber::....\n Lets go ahead and add the 2 dependencies: tracing, and tracing-subscriber\ncargo add tracing cargo add tracing-subscriber Lets test it! Ok now that we have logging setup, let’s add some logs and try it. The tracing library provides logging macros such as, debug!, info!, warn!, error!\nWe will add an new “info” log to the func method.\ninfo!(\"Going to say hello to {}!\", first_name); We will also need to import\nuse tracing::info; Now we can update the function and test.\nCompile \u0026 update the function Just like in the previous article, we need to compile for the lambda env and update the function.\nCompile cargo zigbuild --release --target x86_64-unknown-linux-gnu Update the existing function aws lambda update-function-code --function-name rustTest \\ --zip-file fileb://./lambda.zip Test invoke \u0026 check the logs Now that the lambda is update with the new code, we can go ahead and test and check for our new logs.\nInvoke aws lambda invoke \\ --cli-binary-format raw-in-base64-out \\ --function-name rustTest \\ --payload '{\"firstName\": \"James\"}' \\ output.json Now check the cloudwatch logs again START RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe Version: $LATEST INFO lambda_test: going to say hello to James END RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe REPORT RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe\tDuration: 1.16 ms\tBilled Duration: 33 ms\tMemory Size: 128 MB\tMax Memory Used: 17 MB\tInit Duration: 31.20 ms\tXRAY TraceId: 1-622553a3-5644934610a4952626f10403\tSegmentId: 3b7b79993cba7894\tSampled: true\tSuccess! We now have our log,\nINFO lambda_test: going to say hello to James Reconfigure the logger Update the code for dynamic log levels Now that we have logging working, let’s reconfigure it so that it reads the log level from an environment variable. This is will be much more flexible and give us the ability to turn logging levels up and down while we are developing and debugging, without having to recompile the code.\nWe can update the init_lambda_tracing like this:\nfn init_lambda_tracing() {  tracing_subscriber::fmt()  .with_env_filter(EnvFilter::from_default_env())  // this needs to be set to false, otherwise ANSI color codes will  // show up in a confusing manner in CloudWatch logs.  .with_ansi(false)  // disabling time is handy because CloudWatch will add the ingestion time.  .without_time()  .init(); } We replaced the hardcoded set_max_level... with\n.with_env_filter(EnvFilter::from_default_env()) this will read the logging level from the environment variable RUST_LOG. Now we can change the log level dynamically without having the recompile and update the running code.\nWe will also have to update the Cargo.toml to make sure the “EnvFilter” feature is available from the tracing_subscriber library.\ntracing-subscriber = {version = \"0.3.9\", features = [\"env-filter\"]} Compile \u0026 update the function configuration Now that code is update, we need to rebuild, update the function, and then also the config to add the new \"RUST_LOG\" environment variable. Let’s set the logging level to “DEBUG” for testing.\nCompile cargo zigbuild --release --target x86_64-unknown-linux-gnu Update the existing function aws lambda update-function-code --function-name rustTest \\ --zip-file fileb://./lambda.zip Update the existing function configuration aws lambda update-function-configuration \\ --function-name rustTest \\ --environment Variables=\"{RUST_BACKTRACE=1,RUST_LOG=debug}\" Test invoke again aws lambda invoke \\ --cli-binary-format raw-in-base64-out \\ --function-name rustTest \\ --payload '{\"firstName\": \"James\"}' \\ output.json Check the cloudwatch logs again Logs are much more verbose, we can see lots of new logs from the included dependencies.\nSTART RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41 Version: $LATEST DEBUG hyper::client::connect::http: connecting to 127.0.0.1:9001 DEBUG hyper::client::connect::http: connected to 127.0.0.1:9001 DEBUG hyper::proto::h1::io: flushed 109 bytes DEBUG hyper::proto::h1::io: parsed 7 headers DEBUG hyper::proto::h1::conn: incoming body is content-length (21 bytes) DEBUG hyper::proto::h1::conn: incoming body completed DEBUG hyper::client::pool: pooling idle connection for (\"http\", 127.0.0.1:9001) INFO lambda_test: going to say hello to James DEBUG hyper::client::pool: reuse idle connection for (\"http\", 127.0.0.1:9001) DEBUG hyper::proto::h1::io: flushed 198 bytes DEBUG hyper::proto::h1::io: parsed 3 headers DEBUG hyper::proto::h1::conn: incoming body is content-length (16 bytes) DEBUG hyper::client::connect::http: connecting to 127.0.0.1:9001 DEBUG hyper::proto::h1::conn: incoming body completed DEBUG hyper::client::pool: reuse idle connection for (\"http\", 127.0.0.1:9001) DEBUG hyper::proto::h1::io: flushed 109 bytes END RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41 REPORT RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41\tDuration: 1.46 ms\tBilled Duration: 38 ms\tMemory Size: 128 MB\tMax Memory Used: 17 MB\tInit Duration: 36.11 ms\tXRAY TraceId: 1-622551be-6d58480b496655162937c59c\tSegmentId: 03a6c5576dc28250\tSampled: true\tDEBUG hyper::client::connect::http: connected to 127.0.0.1:9001 DEBUG hyper::client::pool: pooling idle connection for (\"http\", 127.0.0.1:9001) Conclusions We were able to successfully add logging to our “hello world” lambda, and make it possible to dynamically change the logging level based on an environment variable. Using the tracing library made this easy, and the code is straight forward.\nFinally the Source Code The complete project is here in my github repo https://github.com/millerjam/rust_lambda_hello_world\nNext Time Next time, we will look at adding a unit test and finally try switching from building x86 to ARM for even more savings on our lambda executions.\n","wordCount":"1049","inLanguage":"en","datePublished":"2022-03-13T14:35:38-04:00","dateModified":"2022-03-13T14:35:38-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://millerjam.github.io/posts/rust-lambda-hello-world-logging/"},"publisher":{"@type":"Organization","name":"MillerJAM Site","logo":{"@type":"ImageObject","url":"http://millerjam.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://millerjam.github.io/ accesskey=h title="MillerJAM Site (Alt + H)">MillerJAM Site</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Rust Lambda Hello World Logging</h1><div class=post-description>Use the 'tracing' crate to add logging to our Serverless Lambdas written in Rust</div><div class=post-meta><span title="2022-03-13 14:35:38 -0400 -0400">March 13, 2022</span>&nbsp;·&nbsp;5 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#lets-add-some-logging aria-label="Lets add some logging">Lets add some logging</a><ul><li><a href=#init-the-logger aria-label="Init the logger">Init the logger</a></li><li><a href=#fix-the-compile-issues aria-label="Fix the compile issues">Fix the compile issues</a></li></ul></li><li><a href=#lets-test-it aria-label="Lets test it!">Lets test it!</a><ul><li><a href=#compile--update-the-function aria-label="Compile &amp;amp; update the function">Compile & update the function</a><ul><li><a href=#compile aria-label=Compile>Compile</a></li><li><a href=#update-the-existing-function aria-label="Update the existing function">Update the existing function</a></li></ul></li></ul></li><li><a href=#test-invoke--check-the-logs aria-label="Test invoke &amp;amp; check the logs">Test invoke & check the logs</a><ul><li><a href=#invoke aria-label=Invoke>Invoke</a></li><li><a href=#now-check-the-cloudwatch-logs-again aria-label="Now check the cloudwatch logs again">Now check the cloudwatch logs again</a></li></ul></li><li><a href=#reconfigure-the-logger aria-label="Reconfigure the logger">Reconfigure the logger</a><ul><li><a href=#update-the-code-for-dynamic-log-levels aria-label="Update the code for dynamic log levels">Update the code for dynamic log levels</a></li><li><a href=#compile--update-the-function-configuration aria-label="Compile &amp;amp; update the function configuration">Compile & update the function configuration</a><ul><li><a href=#compile-1 aria-label=Compile>Compile</a></li><li><a href=#update-the-existing-function-1 aria-label="Update the existing function">Update the existing function</a></li><li><a href=#update-the-existing-function-configuration aria-label="Update the existing function configuration">Update the existing function configuration</a></li></ul></li><li><a href=#test-invoke-again aria-label="Test invoke again">Test invoke again</a></li><li><a href=#check-the-cloudwatch-logs-again aria-label="Check the cloudwatch logs again">Check the cloudwatch logs again</a></li></ul></li><li><a href=#conclusions aria-label=Conclusions>Conclusions</a><ul><ul><li><a href=#finally-the-source-code aria-label="Finally the Source Code">Finally the Source Code</a></li></ul></ul></li><li><a href=#next-time aria-label="Next Time">Next Time</a></li></ul></div></details></div><div class=post-content><p>In my previous article, I started a tutorial on creating a lambda in Rust. If you missed it, you can catch up on that article here -> <a href=../rust-lambda-hello-world>Rust Lambda Hello World</a></p><h2 id=lets-add-some-logging>Lets add some logging<a hidden class=anchor aria-hidden=true href=#lets-add-some-logging>#</a></h2><p>Before we go much further with our Rust code, let&rsquo;s add some logging. We are take advantage of the <a href=https://docs.rs/tracing/latest/tracing/>tracing library</a> which is already integrated into many of the lambda dependencies.</p><blockquote><p>Details about the tracing library are out of scope for this article, but you can learn more from the <a href=https://docs.rs/tracing/latest/tracing/>tracing crate docs</a></p></blockquote><h3 id=init-the-logger>Init the logger<a hidden class=anchor aria-hidden=true href=#init-the-logger>#</a></h3><p>Setting up the logger requires initializing the tracing subscriber library, the <a href=https://github.com/awslabs/aws-lambda-rust-runtime/tree/v0.5.0/lambda-runtime/examples>AWS Lambda Rust Runtime Examples</a> has a examples with some details about how to get started.</p><p>Here is the code that we will have to add:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>init_lambda_tracing</span>() {
</span></span><span style=display:flex><span>    tracing_subscriber::fmt()        
</span></span><span style=display:flex><span>        .with_max_level(tracing::Level::INFO)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// this needs to be set to false, otherwise ANSI color codes will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// show up in a confusing manner in CloudWatch logs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .with_ansi(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// disabling time is handy because CloudWatch will add the ingestion time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .without_time()
</span></span><span style=display:flex><span>        .init();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I have created a small function <code>init_lambda_tracing()</code> with all the details for setting up the logging. This function will setup the default <code>tracing_subscriber</code> which prints logs to stdout.
The additional methods called on the builder, set the default logging level to &ldquo;info&rdquo; and disable some of the defaults to make things nicer in the Lambda environment. Finally, I added
additional code to the <code>main()</code> to call this function before the lambda runtime setup.</p><h3 id=fix-the-compile-issues>Fix the compile issues<a hidden class=anchor aria-hidden=true href=#fix-the-compile-issues>#</a></h3><p>Even though we did not add any additional <code>import ...</code> lines, we still need to add our new tracing library dependencies to <code>Cargo.toml</code>, before our code will build.</p><blockquote><p>The reason we did not add <code>import..</code> statements is that we fully qualified the crate directly in the code with the prefix <code>tracing_subscriber::...</code>.</p></blockquote><p>Lets go ahead and add the 2 dependencies: <a href=https://crates.io/crates/tracing>tracing</a>, and <a href=https://crates.io/crates/tracing-subscriber>tracing-subscriber</a></p><pre tabindex=0><code>cargo add tracing

cargo add tracing-subscriber
</code></pre><h2 id=lets-test-it>Lets test it!<a hidden class=anchor aria-hidden=true href=#lets-test-it>#</a></h2><p>Ok now that we have logging setup, let&rsquo;s add some logs and try it. The tracing library provides logging macros such as, <code>debug!</code>, <code>info!</code>, <code>warn!</code>, <code>error!</code></p><p>We will add an new &ldquo;info&rdquo; log to the <code>func</code> method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>info<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#34;Going to say hello to {}!&#34;</span>, first_name);
</span></span></code></pre></div><p>We will also need to import</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> tracing::info;
</span></span></code></pre></div><p>Now we can update the function and test.</p><h3 id=compile--update-the-function>Compile & update the function<a hidden class=anchor aria-hidden=true href=#compile--update-the-function>#</a></h3><p>Just like in the previous article, we need to compile for the lambda env and update the function.</p><h4 id=compile>Compile<a hidden class=anchor aria-hidden=true href=#compile>#</a></h4><pre tabindex=0><code>cargo zigbuild --release --target x86_64-unknown-linux-gnu
</code></pre><h4 id=update-the-existing-function>Update the existing function<a hidden class=anchor aria-hidden=true href=#update-the-existing-function>#</a></h4><pre tabindex=0><code>aws lambda update-function-code --function-name rustTest \
  --zip-file fileb://./lambda.zip
</code></pre><h2 id=test-invoke--check-the-logs>Test invoke & check the logs<a hidden class=anchor aria-hidden=true href=#test-invoke--check-the-logs>#</a></h2><p>Now that the lambda is update with the new code, we can go ahead and test and check for our new logs.</p><h3 id=invoke>Invoke<a hidden class=anchor aria-hidden=true href=#invoke>#</a></h3><pre tabindex=0><code>aws lambda invoke \
  --cli-binary-format raw-in-base64-out \
  --function-name rustTest \
  --payload &#39;{&#34;firstName&#34;: &#34;James&#34;}&#39; \
  output.json
</code></pre><h3 id=now-check-the-cloudwatch-logs-again>Now check the cloudwatch logs again<a hidden class=anchor aria-hidden=true href=#now-check-the-cloudwatch-logs-again>#</a></h3><pre tabindex=0><code class=language-log data-lang=log>START RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe Version: $LATEST
INFO lambda_test: going to say hello to James
END RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe
REPORT RequestId: 93bcbe8c-4b2e-4af3-b00d-3b4b27083ebe	Duration: 1.16 ms	Billed Duration: 33 ms	Memory Size: 128 MB	Max Memory Used: 17 MB	Init Duration: 31.20 ms	
XRAY TraceId: 1-622553a3-5644934610a4952626f10403	SegmentId: 3b7b79993cba7894	Sampled: true	
</code></pre><p>Success! We now have our log,</p><pre tabindex=0><code class=language-log data-lang=log>INFO lambda_test: going to say hello to James
</code></pre><h2 id=reconfigure-the-logger>Reconfigure the logger<a hidden class=anchor aria-hidden=true href=#reconfigure-the-logger>#</a></h2><h3 id=update-the-code-for-dynamic-log-levels>Update the code for dynamic log levels<a hidden class=anchor aria-hidden=true href=#update-the-code-for-dynamic-log-levels>#</a></h3><p>Now that we have logging working, let&rsquo;s reconfigure it so that it reads the log level
from an environment variable. This is will be much more flexible and give us the ability to turn logging levels up and down while we are developing and debugging, without having to recompile the code.</p><p>We can update the <code>init_lambda_tracing</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>init_lambda_tracing</span>() {
</span></span><span style=display:flex><span>    tracing_subscriber::fmt()
</span></span><span style=display:flex><span>        .with_env_filter(EnvFilter::from_default_env())
</span></span><span style=display:flex><span>        <span style=color:#75715e>// this needs to be set to false, otherwise ANSI color codes will
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// show up in a confusing manner in CloudWatch logs.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .with_ansi(<span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// disabling time is handy because CloudWatch will add the ingestion time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        .without_time()
</span></span><span style=display:flex><span>        .init();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We replaced the hardcoded <code>set_max_level...</code> with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>.with_env_filter(EnvFilter::from_default_env())
</span></span></code></pre></div><p>this will read the logging level from the
environment variable <code>RUST_LOG</code>. Now we can change the log level dynamically without having the recompile and update the running code.</p><p>We will also have to update the <code>Cargo.toml</code> to make sure the &ldquo;EnvFilter&rdquo; feature is available from the <code>tracing_subscriber</code> library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Cargo.toml data-lang=Cargo.toml><span style=display:flex><span><span style=color:#a6e22e>tracing-subscriber</span> = {<span style=color:#a6e22e>version</span> = <span style=color:#e6db74>&#34;0.3.9&#34;</span>, <span style=color:#a6e22e>features</span> = [<span style=color:#e6db74>&#34;env-filter&#34;</span>]}
</span></span></code></pre></div><h3 id=compile--update-the-function-configuration>Compile & update the function configuration<a hidden class=anchor aria-hidden=true href=#compile--update-the-function-configuration>#</a></h3><p>Now that code is update, we need to rebuild, update the function, and then also the config
to add the new <code>"RUST_LOG"</code> environment variable. Let&rsquo;s set the logging level to &ldquo;DEBUG&rdquo; for testing.</p><h4 id=compile-1>Compile<a hidden class=anchor aria-hidden=true href=#compile-1>#</a></h4><pre tabindex=0><code>cargo zigbuild --release --target x86_64-unknown-linux-gnu
</code></pre><h4 id=update-the-existing-function-1>Update the existing function<a hidden class=anchor aria-hidden=true href=#update-the-existing-function-1>#</a></h4><pre tabindex=0><code>aws lambda update-function-code --function-name rustTest \
  --zip-file fileb://./lambda.zip
</code></pre><h4 id=update-the-existing-function-configuration>Update the existing function configuration<a hidden class=anchor aria-hidden=true href=#update-the-existing-function-configuration>#</a></h4><pre tabindex=0><code>aws lambda update-function-configuration \
    --function-name  rustTest \
    --environment Variables=&#34;{RUST_BACKTRACE=1,RUST_LOG=debug}&#34;
</code></pre><h3 id=test-invoke-again>Test invoke again<a hidden class=anchor aria-hidden=true href=#test-invoke-again>#</a></h3><pre tabindex=0><code>aws lambda invoke \
  --cli-binary-format raw-in-base64-out \
  --function-name rustTest \
  --payload &#39;{&#34;firstName&#34;: &#34;James&#34;}&#39; \
  output.json
</code></pre><h3 id=check-the-cloudwatch-logs-again>Check the cloudwatch logs again<a hidden class=anchor aria-hidden=true href=#check-the-cloudwatch-logs-again>#</a></h3><p>Logs are much more verbose, we can see lots of new logs from the included dependencies.</p><pre tabindex=0><code>START RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41 Version: $LATEST
DEBUG hyper::client::connect::http: connecting to 127.0.0.1:9001
DEBUG hyper::client::connect::http: connected to 127.0.0.1:9001
DEBUG hyper::proto::h1::io: flushed 109 bytes
DEBUG hyper::proto::h1::io: parsed 7 headers
DEBUG hyper::proto::h1::conn: incoming body is content-length (21 bytes)
DEBUG hyper::proto::h1::conn: incoming body completed
DEBUG hyper::client::pool: pooling idle connection for (&#34;http&#34;, 127.0.0.1:9001)
INFO lambda_test: going to say hello to James
DEBUG hyper::client::pool: reuse idle connection for (&#34;http&#34;, 127.0.0.1:9001)
DEBUG hyper::proto::h1::io: flushed 198 bytes
DEBUG hyper::proto::h1::io: parsed 3 headers
DEBUG hyper::proto::h1::conn: incoming body is content-length (16 bytes)
DEBUG hyper::client::connect::http: connecting to 127.0.0.1:9001
DEBUG hyper::proto::h1::conn: incoming body completed
DEBUG hyper::client::pool: reuse idle connection for (&#34;http&#34;, 127.0.0.1:9001)
DEBUG hyper::proto::h1::io: flushed 109 bytes
END RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41
REPORT RequestId: 9ebad5dc-3cee-4302-a0f8-0e592e432f41	Duration: 1.46 ms	Billed Duration: 38 ms	Memory Size: 128 MB	Max Memory Used: 17 MB	Init Duration: 36.11 ms	
XRAY TraceId: 1-622551be-6d58480b496655162937c59c	SegmentId: 03a6c5576dc28250	Sampled: true	
DEBUG hyper::client::connect::http: connected to 127.0.0.1:9001
DEBUG hyper::client::pool: pooling idle connection for (&#34;http&#34;, 127.0.0.1:9001)
</code></pre><h2 id=conclusions>Conclusions<a hidden class=anchor aria-hidden=true href=#conclusions>#</a></h2><p>We were able to successfully add logging to our &ldquo;hello world&rdquo; lambda, and make it possible to dynamically change the logging level based on an environment variable. Using the tracing library made this easy, and the code is straight forward.</p><h4 id=finally-the-source-code>Finally the Source Code<a hidden class=anchor aria-hidden=true href=#finally-the-source-code>#</a></h4><p>The complete project is here in my github repo <a href=https://github.com/millerjam/rust_lambda_hello_world>https://github.com/millerjam/rust_lambda_hello_world</a></p><h2 id=next-time>Next Time<a hidden class=anchor aria-hidden=true href=#next-time>#</a></h2><p>Next time, we will look at adding a unit test and finally try switching from building x86 to ARM for even more savings on our lambda executions.</p></div><footer class=post-footer></footer></article></main><footer class=footer><span>&copy; 2022 <a href=http://millerjam.github.io/>MillerJAM Site</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>